#!/bin/bash
# Usage: push [from_host]

myhost=$(hostname)
mydir=$(dirname $0)
if [ $# -gt 0 ]; then
    from_host=$1
else
    from_host=$myhost
fi

ssh rpi0 touch $mydir/.wait.$from_host

cd $mydir
if [ "$from_host" = "$myhost" ]; then
    for ((i=0; i<16; i++)); do
        myip=$(ifconfig wlan0 | grep -oP "inet addr:\K\S+") && break
        sleep 1
    done
    
    test "$myhost" = "rpi0" && git pull --commit
    update_file=boot.log.$myhost
    date > $update_file
date > ~/temp.txt
    sed -e 's/.\[32m//' -e 's/.\[0m//' /var/log/boot.log >> $update_file
    echo "Host $(hostname) IP address $myip" >> $update_file
else
    update_file=boot.log.$from_host
    scp $from_host:$mydir/$update_file .
fi

if [ "$myhost" = "rpi0" ]; then 
    first_wait=$(ls .wait.* | grep -oP ".wait.\K\S+" | head -1)
    rm .wait.$from_host

    if [ "$from_host" = "$first_wait" ]; then
        while [ -f .wait.* ]; do
            sleep 1
        done
        git commit -am "Updated boot.log"
        git push origin
    fi
else
    ssh rpi0 $0 $myhost
fi
